<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Order Flow Test</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .test-result.success {
      background: #d1fae5;
      color: #065f46;
    }
    .test-result.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .test-result.info {
      background: #dbeafe;
      color: #1e40af;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      opacity: 0.9;
    }
    .demo-row {
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      margin: 10px 0;
    }
    .demo-expansion {
      padding: 15px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h1>Quick Order Flow Diagnostic Test</h1>
    <p>This page tests the complete flow of the expiry selector feature.</p>

    <!-- Test 1: Check if scripts are loaded -->
    <div class="test-section">
      <h2>Test 1: Script Loading</h2>
      <button onclick="test1()">Run Test</button>
      <div id="test1-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 2: Check if instance is active -->
    <div class="test-section">
      <h2>Test 2: Active Instance Check</h2>
      <button onclick="test2()">Run Test</button>
      <div id="test2-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 3: Test API expiry fetch -->
    <div class="test-section">
      <h2>Test 3: API Expiry Fetch</h2>
      <button onclick="test3()">Run Test</button>
      <div id="test3-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 4: Test QuickOrderHandler.fetchAvailableExpiries -->
    <div class="test-section">
      <h2>Test 4: QuickOrderHandler.fetchAvailableExpiries()</h2>
      <button onclick="test4()">Run Test</button>
      <div id="test4-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 5: Test renderTradingControls with expiries -->
    <div class="test-section">
      <h2>Test 5: Render Trading Controls with Expiries</h2>
      <button onclick="test5()">Run Test</button>
      <div id="test5-result" class="test-result" style="display:none;"></div>
      <div id="test5-demo"></div>
    </div>

    <!-- Test 6: Full Integration Test -->
    <div class="test-section">
      <h2>Test 6: Full Integration Test</h2>
      <p>Simulates the complete flow: expand row → switch to FUTURES → show expiry selector</p>
      <button onclick="test6()">Run Test</button>
      <div id="test6-result" class="test-result" style="display:none;"></div>
      <div id="test6-demo"></div>
    </div>

    <!-- Run All Tests -->
    <div class="test-section">
      <h2>Run All Tests</h2>
      <button onclick="runAllTests()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-size: 16px; font-weight: bold;">
        Run All Tests
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/js/api-client.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/quick-order.js"></script>

  <script>
    let instanceId = null;

    function showResult(testId, message, type = 'info') {
      const resultDiv = document.getElementById(`${testId}-result`);
      resultDiv.style.display = 'block';
      resultDiv.className = `test-result ${type}`;
      resultDiv.textContent = message;
    }

    // Test 1: Check if scripts are loaded
    function test1() {
      console.log('Running Test 1: Script Loading');

      const checks = {
        'window.api': typeof api !== 'undefined',
        'window.Utils': typeof Utils !== 'undefined',
        'window.quickOrder': typeof quickOrder !== 'undefined',
        'api.getExpiry': typeof api?.getExpiry === 'function',
        'quickOrder.fetchAvailableExpiries': typeof quickOrder?.fetchAvailableExpiries === 'function',
      };

      const allPassed = Object.values(checks).every(v => v);

      let message = 'Script Loading Check:\n';
      for (const [key, value] of Object.entries(checks)) {
        message += `  ${value ? '✅' : '❌'} ${key}\n`;
      }

      showResult('test1', message, allPassed ? 'success' : 'error');
      return allPassed;
    }

    // Test 2: Check if instance is active
    async function test2() {
      console.log('Running Test 2: Active Instance Check');

      try {
        const response = await api.getInstances({ is_active: 1 });

        if (!response.data || response.data.length === 0) {
          showResult('test2', '❌ No active instances found', 'error');
          return false;
        }

        instanceId = response.data[0].id;
        const message = `✅ Found ${response.data.length} active instance(s)\n` +
                       `   Instance ID: ${instanceId}\n` +
                       `   Name: ${response.data[0].name}\n` +
                       `   Health: ${response.data[0].health_status}`;

        showResult('test2', message, 'success');
        return true;
      } catch (error) {
        showResult('test2', `❌ Error: ${error.message}`, 'error');
        return false;
      }
    }

    // Test 3: Test API expiry fetch
    async function test3() {
      console.log('Running Test 3: API Expiry Fetch');

      if (!instanceId) {
        const test2Result = await test2();
        if (!test2Result) {
          showResult('test3', '❌ Cannot run test without active instance', 'error');
          return false;
        }
      }

      try {
        const response = await api.getExpiry('NIFTY', instanceId, 'NFO');

        if (!response.data || response.data.length === 0) {
          showResult('test3', '⚠️ API call succeeded but returned no expiries', 'error');
          return false;
        }

        const message = `✅ API returned ${response.data.length} expiries\n` +
                       `   First 5: ${response.data.slice(0, 5).join(', ')}`;

        showResult('test3', message, 'success');
        return true;
      } catch (error) {
        showResult('test3', `❌ Error: ${error.message}`, 'error');
        return false;
      }
    }

    // Test 4: Test QuickOrderHandler.fetchAvailableExpiries
    async function test4() {
      console.log('Running Test 4: QuickOrderHandler.fetchAvailableExpiries');

      try {
        const expiries = await quickOrder.fetchAvailableExpiries('NIFTY', 'NFO');

        if (!expiries || expiries.length === 0) {
          showResult('test4', '⚠️ Method succeeded but returned no expiries', 'error');
          return false;
        }

        const message = `✅ QuickOrderHandler fetched ${expiries.length} expiries\n` +
                       `   First 5: ${expiries.slice(0, 5).join(', ')}`;

        showResult('test4', message, 'success');
        return true;
      } catch (error) {
        showResult('test4', `❌ Error: ${error.message}`, 'error');
        return false;
      }
    }

    // Test 5: Test renderTradingControls with expiries
    async function test5() {
      console.log('Running Test 5: Render Trading Controls');

      try {
        const expiries = await quickOrder.fetchAvailableExpiries('NIFTY', 'NFO');

        if (!expiries || expiries.length === 0) {
          showResult('test5', '❌ No expiries to render', 'error');
          return false;
        }

        const html = quickOrder.renderTradingControls({
          watchlistId: 1,
          symbolId: 999,
          symbol: 'NIFTY',
          exchange: 'NFO',
          symbolType: 'INDEX',
          tradeMode: 'FUTURES',
          optionsLeg: 'ATM',
          quantity: 1,
          expiries: expiries,
          selectedExpiry: expiries[0],
        });

        // Check if HTML contains expiry selector
        const hasExpirySelector = html.includes('select-expiry');

        if (!hasExpirySelector) {
          showResult('test5', '❌ Rendered HTML does not contain expiry selector', 'error');
          return false;
        }

        // Render demo
        const demoDiv = document.getElementById('test5-demo');
        demoDiv.innerHTML = `
          <div class="demo-row">
            <div style="padding: 10px; background: white;">
              <strong>Demo Rendering:</strong>
            </div>
            <div class="demo-expansion">
              ${html}
            </div>
          </div>
        `;

        showResult('test5', `✅ Trading controls rendered successfully\n   Contains ${expiries.length} expiry options`, 'success');
        return true;
      } catch (error) {
        showResult('test5', `❌ Error: ${error.message}`, 'error');
        return false;
      }
    }

    // Test 6: Full Integration Test
    async function test6() {
      console.log('Running Test 6: Full Integration Test');

      const demoDiv = document.getElementById('test6-demo');

      try {
        // Step 1: Create mock watchlist table
        demoDiv.innerHTML = `
          <div class="demo-row">
            <table class="table" id="watchlist-table-1">
              <tbody>
                <tr class="symbol-row" data-symbol-id="999" data-symbol="NIFTY" data-exchange="NFO">
                  <td>
                    <button class="btn-toggle-expansion"
                            data-toggle-symbol="999"
                            onclick="testToggleExpansion()">
                      ▼
                    </button>
                  </td>
                  <td><strong>NIFTY</strong></td>
                  <td>NFO</td>
                  <td><span class="badge badge-primary">INDEX</span></td>
                </tr>
                <tr id="expansion-row-999" class="expansion-row" style="display: none;">
                  <td colspan="11" class="expansion-cell">
                    <div id="expansion-content-999" class="expansion-content" data-loaded="false">
                      <p class="text-neutral-500 text-sm">Loading...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;

        showResult('test6', '✅ Mock watchlist created. Click the ▼ button to test expansion.', 'success');
        return true;
      } catch (error) {
        showResult('test6', `❌ Error: ${error.message}`, 'error');
        return false;
      }
    }

    // Helper for test 6
    window.testToggleExpansion = async function() {
      console.log('Test: Toggling row expansion');

      const expansionRow = document.getElementById('expansion-row-999');
      const contentDiv = document.getElementById('expansion-content-999');
      const toggleBtn = document.querySelector('[data-toggle-symbol="999"]');

      if (expansionRow.style.display === 'none') {
        // Expand
        expansionRow.style.display = 'table-row';
        toggleBtn.textContent = '▲';

        // Load content
        contentDiv.innerHTML = '<p class="text-neutral-500 text-sm">Fetching expiries...</p>';

        try {
          const expiries = await quickOrder.fetchAvailableExpiries('NIFTY', 'NFO');

          if (!expiries || expiries.length === 0) {
            contentDiv.innerHTML = '<p class="text-error">No expiries found</p>';
            return;
          }

          // Render with FUTURES mode
          const html = quickOrder.renderTradingControls({
            watchlistId: 1,
            symbolId: 999,
            symbol: 'NIFTY',
            exchange: 'NFO',
            symbolType: 'INDEX',
            tradeMode: 'FUTURES',
            optionsLeg: 'ATM',
            quantity: 1,
            expiries: expiries,
            selectedExpiry: expiries[0],
          });

          contentDiv.innerHTML = html;
          contentDiv.dataset.loaded = 'true';

          console.log('✅ Expansion loaded with expiry selector');
          showResult('test6', `✅ Expansion loaded successfully with ${expiries.length} expiries`, 'success');
        } catch (error) {
          contentDiv.innerHTML = `<p class="text-error">Error: ${error.message}</p>`;
          showResult('test6', `❌ Error loading expansion: ${error.message}`, 'error');
        }
      } else {
        // Collapse
        expansionRow.style.display = 'none';
        toggleBtn.textContent = '▼';
      }
    };

    // Run all tests
    async function runAllTests() {
      console.log('=== Running All Tests ===');

      const results = {
        test1: await test1(),
        test2: await test2(),
        test3: await test3(),
        test4: await test4(),
        test5: await test5(),
        test6: await test6(),
      };

      const passed = Object.values(results).filter(v => v).length;
      const total = Object.keys(results).length;

      console.log(`=== Test Results: ${passed}/${total} passed ===`);

      if (passed === total) {
        alert(`✅ All tests passed (${passed}/${total})!\n\nThe expiry selector should work in the dashboard.\nTry hard refreshing (Ctrl+Shift+R) the dashboard page.`);
      } else {
        const failed = Object.entries(results)
          .filter(([, passed]) => !passed)
          .map(([test]) => test);
        alert(`⚠️ Some tests failed (${passed}/${total})\n\nFailed tests: ${failed.join(', ')}\n\nCheck the test results above for details.`);
      }
    }

    // Auto-run test 1 on load
    window.addEventListener('load', () => {
      console.log('Page loaded, running Test 1...');
      test1();
    });
  </script>
</body>
</html>
