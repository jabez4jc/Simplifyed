<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Instance & Test Expiry Selector</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîß Setup Instance & Test Expiry Selector</h1>
    <p>This page will add the Flattrade instance and test the expiry selector functionality.</p>

    <button id="addInstanceBtn" onclick="addInstance()">1. Add Instance</button>
    <button id="testExpiryBtn" onclick="testExpiry()" disabled>2. Test Expiry Fetch</button>
    <button id="goDashboardBtn" onclick="goToDashboard()">3. Go to Dashboard</button>
  </div>

  <div class="card">
    <h2>üìã Console Output</h2>
    <div id="output"></div>
  </div>

  <script>
    const output = document.getElementById('output');
    const addBtn = document.getElementById('addInstanceBtn');
    const testBtn = document.getElementById('testExpiryBtn');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const span = document.createElement('span');
      span.className = type;
      span.textContent = `[${timestamp}] ${message}\n`;
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }

    async function addInstance() {
      addBtn.disabled = true;
      log('Starting instance setup...', 'info');

      try {
        log('Adding Flattrade OpenAlgo instance...', 'info');

        const response = await fetch('/api/v1/instances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            name: 'Flattrade OpenAlgo',
            host_url: 'https://flattrade.simplifyed.in',
            api_key: '9f96b8911d7f4536d2185510e9105f229db01b578082f4c7eefa03395f72c3ab',
            is_active: true,
            order_placement_enabled: true,
            is_analyzer_mode: false
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          log('‚úÖ Instance added successfully!', 'success');
          log(`   Instance ID: ${result.data.id}`, 'success');
          log(`   Name: ${result.data.name}`, 'info');
          log(`   Host: ${result.data.host_url}`, 'info');
          testBtn.disabled = false;
        } else {
          log(`‚ö†Ô∏è  ${result.message || 'Instance may already exist'}`, 'warning');
          testBtn.disabled = false; // Enable anyway, might already exist
        }
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        addBtn.disabled = false;
      }
    }

    async function testExpiry() {
      testBtn.disabled = true;
      log('\nTesting expiry fetch...', 'info');

      try {
        // Get instances
        log('Fetching active instances...', 'info');
        const instancesResponse = await fetch('/api/v1/instances?is_active=1', {
          credentials: 'include'
        });
        const instancesResult = await instancesResponse.json();

        if (!instancesResult.data || instancesResult.data.length === 0) {
          log('‚ùå No active instances found!', 'error');
          return;
        }

        const instance = instancesResult.data[0];
        log(`‚úÖ Found instance: ${instance.name} (ID: ${instance.id})`, 'success');

        // Test expiry fetch for NIFTY
        log('\nFetching expiries for NIFTY...', 'info');
        const expiryResponse = await fetch(
          `/api/v1/symbols/expiry?symbol=NIFTY&instanceId=${instance.id}&exchange=NFO`,
          { credentials: 'include' }
        );
        const expiryResult = await expiryResponse.json();

        if (expiryResult.data && expiryResult.data.length > 0) {
          log(`‚úÖ Found ${expiryResult.data.length} expiries for NIFTY:`, 'success');
          expiryResult.data.slice(0, 10).forEach(exp => {
            log(`   üìÖ ${exp.expiry || exp}`, 'info');
          });
          if (expiryResult.data.length > 10) {
            log(`   ... and ${expiryResult.data.length - 10} more`, 'info');
          }

          log('\n‚úÖ Expiry selector should now work!', 'success');
          log('üëâ Click "Go to Dashboard" to test it', 'info');
        } else {
          log('‚ö†Ô∏è  No expiries found', 'warning');
        }

        // Test BANKNIFTY too
        log('\nFetching expiries for BANKNIFTY...', 'info');
        const bnExpiryResponse = await fetch(
          `/api/v1/symbols/expiry?symbol=BANKNIFTY&instanceId=${instance.id}&exchange=NFO`,
          { credentials: 'include' }
        );
        const bnExpiryResult = await bnExpiryResponse.json();

        if (bnExpiryResult.data && bnExpiryResult.data.length > 0) {
          log(`‚úÖ Found ${bnExpiryResult.data.length} expiries for BANKNIFTY`, 'success');
          bnExpiryResult.data.slice(0, 5).forEach(exp => {
            log(`   üìÖ ${exp.expiry || exp}`, 'info');
          });
        }

      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        testBtn.disabled = false;
      }
    }

    function goToDashboard() {
      window.location.href = '/dashboard.html';
    }

    // Auto-log on page load
    log('üöÄ Ready to setup instance and test expiry selector', 'success');
    log('Click "1. Add Instance" to begin', 'info');
  </script>
</body>
</html>
